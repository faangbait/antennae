---
- name: Configure universal functionality / POSIX-related changes
  hosts: localhost
  become: yes

  vars:
    static_ip: '10.0.0.252'
    static_gateway: '10.0.0.1'
    static_dns: 
      - '10.0.0.1'
      - '9.9.9.9'
      - '1.1.1.1'
    network_interface: 'enp8s0'

    block_devices:
      - { dir: '/var/storage', uuid: '07fed395-5daa-4800-8b87-b4f888ef3f07', type: 'data' }
      - { dir: '/var/cache', uuid: 'd6cb375e-85da-49b4-884d-a9bd21d6ebcf', type: 'cache' }

    tmpfs_devices:
      - { dir: '/tmp', size: '4g'}
      
  tasks:
    - name: Reconfigure fstab
      ansible.posix.mount:
        path: '{{ item.dir }}'
        src: 'UUID={{ item.uuid }}'
        state: mounted
        fstype: ext4
        opts: defaults,rw,acl
        backup: yes
      loop: '{{ block_devices }}'

    - name: Unmount data directories
      ansible.posix.mount:
        path: '{{ item.dir }}'
        state: unmounted
      loop: '{{ block_devices }}'
      when: '{{ item.type }} == data'

    - name: Ensure data directories exist
      ansible.builtin.file:
        path: '{{ item.dir }}'
        state: directory
        mode: '0711'
        attributes: '+i'
      loop: '{{ block_devices }}'
      when: '{{ item.type }} == data'

    - name: Update fstab for directories
      ansible.posix.mount:
        path: '{{ item.dir }}'
        src: 'UUID={{ item.uuid }}'
        state: mounted
        fstype: ext4
        opts: defaults,rw,acl
        backup: yes
      loop: '{{ block_devices }}'

    - name: Set data directory ACL
      ansible.posix.acl:
        path: '{{ item.dir }}'
        entity: wheel
        etype: group
        permissions: rwx
        state: present
      loop: '{{ block_devices }}'

    - name: Set data directory default ACL
      ansible.posix.acl:
        path: '{{ item.dir }}'
        entity: wheel
        etype: group
        permissions: rwx
        default: yes
        state: present
      loop: '{{ block_devices }}'

    - name: Resize tmpfs
      ansible.posix.mount:
        path: '{{ item.dir }}'
        src: tmpfs
        state: mounted
        fstype: tmpfs
        opts: 'size={{ item.size }}'
        backup: yes
      loop: '{{ tmpfs_devices }}'

    - name: Set swappiness to 1
      lineinfile:
        path: /etc/sysctl.d/10-swap.conf
        create: yes
        line: vm.swappiness = 1
        
    - name: Install nmcli
      package: 
        name: NetworkManager

    - name: Configure nmcli
      community.general.nmcli:
        conn_name: 'Wired connection 1'
        ifname: '{{ network_interface }}'
        type: ethernet
        ip4: '{{ static_ip }}/24'
        gw4: '{{ static_gateway }}'
        dns4: '{{ static_dns }}'
        state: present
