---
- name: Install required systems applications
  package:
    name:
      - gnupg
      - expect
      - lshw
    state: present

- name: Reconfigure fstab
  ansible.posix.mount:
    path: '{{ item.dir }}'
    src: 'UUID={{ item.uuid }}'
    state: mounted
    fstype: ext4
    opts: defaults,rw,acl
    backup: yes
  loop: '{{ block_devices }}'

# This works, but this playlist is stored on a data directory, so I can't unmount it...
# - name: Unmount data directories
#   ansible.posix.mount:
#     path: '{{ item.dir }}'
#     state: unmounted
#   loop: '{{ block_devices }}'
#   when: item.type == 'data'

# - name: Ensure data directories exist
#   ansible.builtin.file:
#     path: '{{ item.dir }}'
#     state: directory
#     mode: '0711'
#     attributes: '+i'
#   loop: '{{ block_devices }}'
#   when: item.type == 'data'

- name: Update fstab for directories
  ansible.posix.mount:
    path: '{{ item.dir }}'
    src: 'UUID={{ item.uuid }}'
    state: mounted
    fstype: ext4
    opts: defaults,rw,acl
    backup: yes
  loop: '{{ block_devices }}'

- name: Set data directory ACL
  ansible.posix.acl:
    path: '{{ item.dir }}'
    entity: wheel
    etype: group
    permissions: rwx
    state: present
  loop: '{{ block_devices }}'

- name: Set data directory default ACL
  ansible.posix.acl:
    path: '{{ item.dir }}'
    entity: wheel
    etype: group
    permissions: rwx
    default: yes
    state: present
  loop: '{{ block_devices }}'

- name: Resize tmpfs
  ansible.posix.mount:
    path: '{{ item.dir }}'
    src: tmpfs
    state: mounted
    fstype: tmpfs
    opts: 'size={{ item.size }}'
    backup: yes
  loop: '{{ tmpfs_devices }}'

    
# - name: Install nmcli
#   package: 
#     name: NetworkManager

# - name: Configure nmcli
#   community.general.nmcli:
#     conn_name: 'Wired connection 1'
#     ifname: '{{ network_interface }}'
#     type: ethernet
#     ip4: '{{ static_ip }}/24'
#     gw4: '{{ static_gateway }}'
#     dns4: '{{ static_dns }}'
#     state: present

